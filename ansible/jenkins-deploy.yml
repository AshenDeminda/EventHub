---
- name: Jenkins-driven deploy to EC2
  hosts: all
  become: true
  vars:
    dest_dir: /home/ubuntu/app

  tasks:
    - name: Ensure destination directory exists
      file:
        path: "{{ dest_dir }}"
        state: directory
        owner: "{{ ansible_user | default('ubuntu') }}"
        mode: '0755'

    - name: Stop and remove existing containers
      shell: |
        if [ -f "{{ dest_dir }}/docker-compose.yml" ]; then
          docker compose -f "{{ dest_dir }}/docker-compose.yml" down || true
        fi

    - name: Aggressive cleanup - system prune (preserves volumes)
      shell: docker system prune -af || true

    - name: Copy production docker-compose.yml to remote
      copy:
        src: ../docker-compose.prod.yml
        dest: "{{ dest_dir }}/docker-compose.yml"
        mode: '0644'

    - name: Copy backend image tar
      copy:
        src: ../build/backend.tar
        dest: "{{ dest_dir }}/backend.tar"
        mode: '0644'
      ignore_errors: true

    - name: Load backend image
      shell: |
        if [ -f "{{ dest_dir }}/backend.tar" ]; then
          docker load -i "{{ dest_dir }}/backend.tar" || true
        fi

    - name: Delete backend tar to free space
      file:
        path: "{{ dest_dir }}/backend.tar"
        state: absent

    - name: Copy frontend image tar
      copy:
        src: ../build/frontend.tar
        dest: "{{ dest_dir }}/frontend.tar"
        mode: '0644'
      ignore_errors: true

    - name: Load frontend image
      shell: |
        if [ -f "{{ dest_dir }}/frontend.tar" ]; then
          docker load -i "{{ dest_dir }}/frontend.tar" || true
        fi

    - name: Delete frontend tar to free space
      file:
        path: "{{ dest_dir }}/frontend.tar"
        state: absent

    - name: Start services via docker compose
      shell: docker compose -f "{{ dest_dir }}/docker-compose.yml" up -d --remove-orphans
      args:
        chdir: "{{ dest_dir }}"
