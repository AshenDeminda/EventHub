---
- name: Jenkins-driven deploy to EC2
  hosts: all
  become: true
  vars:
    dest_dir: /home/ubuntu/app

  tasks:
    - name: Ensure destination directory exists
      file:
        path: "{{ dest_dir }}"
        state: directory
        owner: "{{ ansible_user | default('ubuntu') }}"
        mode: '0755'

    - name: Stop and remove existing containers (if any)
      shell: |
        if [ -f "{{ dest_dir }}/docker-compose.yml" ]; then
          docker compose -f "{{ dest_dir }}/docker-compose.yml" down || true
        fi


    - name: Remove all stopped containers (safe-guard)
      shell: docker rm -f $(docker ps -aq) || true


    - name: Prune unused images
      shell: docker image prune -af || true


    - name: Prune unused volumes
      shell: docker volume prune -f || true


    - name: Copy docker-compose.yml to remote
      copy:
        src: ../docker-compose.yml
        dest: "{{ dest_dir }}/docker-compose.yml"
        mode: '0644'

    - name: Copy backend image tar from Jenkins workspace
      copy:
        src: ../build/backend.tar
        dest: "{{ dest_dir }}/backend.tar"
        mode: '0644'
      ignore_errors: true

    - name: Copy frontend image tar from Jenkins workspace
      copy:
        src: ../build/frontend.tar
        dest: "{{ dest_dir }}/frontend.tar"
        mode: '0644'
      ignore_errors: true

    - name: Load backend image (if present)
      shell: |
        if [ -f "{{ dest_dir }}/backend.tar" ]; then
          docker load -i "{{ dest_dir }}/backend.tar" || true
        fi


    - name: Load frontend image (if present)
      shell: |
        if [ -f "{{ dest_dir }}/frontend.tar" ]; then
          docker load -i "{{ dest_dir }}/frontend.tar" || true
        fi


    - name: Start services via docker-compose
      shell: docker compose -f "{{ dest_dir }}/docker-compose.yml" up -d --build --remove-orphans
      args:
        chdir: "{{ dest_dir }}"
